<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 80px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            overflow-x: hidden;
        }
        
        /* Sidebar Styles */
        #sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        #sidebar .sidebar-header {
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        #sidebar .sidebar-header img {
            height: 40px;
            margin-bottom: 10px;
        }
        
        #sidebar .sidebar-header h3 {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        #sidebar .sidebar-menu {
            padding: 1rem 0;
        }
        
        #sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1.5rem;
            margin: 0.25rem 0;
            border-radius: 0;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        #sidebar .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        #sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
        }
        
        #sidebar .nav-link i {
            margin-right: 10px;
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }
        
        #sidebar .nav-link .link-text {
            transition: opacity 0.3s;
        }
        
        /* Main Content Styles */
        #content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: all 0.3s;
        }
        
        /* Top Navbar */
        .top-navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 0.75rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        /* Dashboard Cards */
        .dashboard-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-icon {
            font-size: 2rem;
            opacity: 0.7;
        }
        
        .card-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        .card-success {
            background: linear-gradient(135deg, #2bde8c 0%, #1eae6e 100%);
            color: white;
        }
        
        .card-warning {
            background: linear-gradient(135deg, #ffb347 0%, #ff8c00 100%);
            color: white;
        }
        
        .card-danger {
            background: linear-gradient(135deg, #ff5e62 0%, #ff2d55 100%);
            color: white;
        }
        
        /* Action Buttons */
        .action-btn {
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn i {
            margin-right: 8px;
        }
        
        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            padding: 1rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .data-table tr:hover td {
            background-color: #f8f9fa;
        }
        
        /* Badges */
        .badge-admin {
            background-color: #667eea;
            color: white;
        }
        
        .badge-user {
            background-color: #6c757d;
            color: white;
        }
        .badge-active {
        background-color: #d1fae5; /* light green */
        color: #065f46;           /* dark green text */
        border: 1px solid #10b981;
        }

        .badge-inactive {
        background-color: #fee2e2; /* light red */
        color: #991b1b;            /* dark red text */
        border: 1px solid #ef4444;
        }
        
        /* Add to your CSS */
.fas.fa-key.text-success {
    color: #28a745 !important;
}

.fas.fa-key.text-muted {
    color: #6c757d !important;
}

/* Style for API key section */
.api-key-section {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 20px;
}

.api-key-section h6 {
    color: #495057;
    font-weight: 600;
}
        
        /* Responsive Adjustments */
        @media (max-width: 992px) {
            #sidebar {
                width: var(--sidebar-collapsed-width);
            }
            
            #sidebar .link-text {
                opacity: 0;
                display: none;
            }
            
            #sidebar .sidebar-header h3 {
                display: none;
            }
            
            #sidebar .sidebar-header img {
                margin-bottom: 0;
            }
            
            #content {
                margin-left: var(--sidebar-collapsed-width);
            }
        }
        
        @media (max-width: 768px) {
            #sidebar {
                width: 0;
                overflow: hidden;
            }
            
            #content {
                margin-left: 0;
            }
            
            .top-navbar {
                padding: 0.5rem;
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Settings Cards */
        .settings-card {
            cursor: pointer;
            height: 100%;
            transition: all 0.3s;
        }
        
        .settings-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .settings-card .card-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .settings-card .card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sidebar-header">
            <img src="logo.png" alt="Logo" style="width: 70px; height: 70px;">
            <h3>Super Admin</h3>
        </div>
        <div class="sidebar-menu">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="dashboard" onclick="showDashboard()">
                        <i class="fas fa-tachometer-alt"></i>
                        <span class="link-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="companies" onclick="loadCompanies()">
                        <i class="fas fa-building"></i>
                        <span class="link-text">Companies</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="users" onclick="loadUsers()">
                        <i class="fas fa-users"></i>
                        <span class="link-text">Users</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="settings" onclick="showSettings()">
                        <i class="fas fa-cog"></i>
                        <span class="link-text">Settings</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="link-text">Logout</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div id="content">
        <!-- Top Navbar -->
        <nav class="top-navbar navbar navbar-expand navbar-light bg-white">
            <div class="container-fluid">
                <button class="btn btn-link d-md-none" type="button" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="ms-auto d-flex align-items-center">
                    <div class="user-info">
                        <div class="avatar" id="userInitial">A</div>
                        <div>
                            <div class="fw-bold" id="userName">Admin</div>
                            <small class="text-muted">Super Admin</small>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="container-fluid py-4">
            <!-- Welcome Section -->
            <div class="row mb-4 animate-fade">
                <div class="col-12">
                    
                </div>
            </div>

            <!-- Message Alert -->
            <div id="message" class="row mb-4" style="display: none;">
                <div class="col-12">
                    <div class="alert" id="alertMessage" role="alert">
                        <!-- Message content will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4 animate-fade" id="statsCards">
                <div class="col-md-6 col-lg-3">
                    <div class="card dashboard-card card-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="card-title mb-1" id="companiesCount">0</h3>
                                    <p class="card-text mb-0">Total Companies</p>
                                </div>
                                <i class="fas fa-building card-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card dashboard-card card-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="card-title mb-1" id="usersCount">0</h3>
                                    <p class="card-text mb-0">Total Users</p>
                                </div>
                                <i class="fas fa-users card-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card dashboard-card card-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="card-title mb-1" id="inactiveCompaniesCount">0</h3>
                                    <p class="card-text mb-0">Inactive Companies</p>
                                </div>
                                <i class="fas fa-building card-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card dashboard-card card-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="card-title mb-1" id="inactiveUsersCount">0</h3>
                                    <p class="card-text mb-0">Inactive Users</p>
                                </div>
                                <i class="fas fa-users card-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Section -->
            <div class="row animate-fade">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0" id="dataTitle">Dashboard Overview</h5>
                                <div class="dropdown" id="dataFilterDropdown" style="display: none;">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-filter"></i> Filter
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="loadCompanies()">Companies</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="loadUsers()">Users</a></li>
                                    </ul>
                                </div>
                                <div id="statusFilter" style="display: none;">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary active" onclick="filterByStatus('all')">All</button>
                                        <button type="button" class="btn btn-outline-success" onclick="filterByStatus('active')">Active</button>
                                        <button type="button" class="btn btn-outline-danger" onclick="filterByStatus('inactive')">Inactive</button>
                                    </div>
                                </div>
                            </div>
                            <div id="dataContent">
                                <p class="text-muted text-center py-4">Welcome to Super Admin Dashboard. Use the sidebar to navigate.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Company Modal -->
    <!-- Company Modal -->
<div class="modal fade" id="companyModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="companyModalLabel">Create New Company</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="companyForm" novalidate>
                <div class="modal-body">
                    <!-- Basic Information Section -->
                     <div class="mb-3">
                        <label for="companyLogo" class="form-label">Company Logo</label>
                        <input type="file" class="form-control" id="companyLogo" accept="image/jpeg,image/png,image/gif">
                        <div class="form-text">Max file size: 1MB (JPEG, PNG, GIF)</div>
                    </div>
                    <div id="logoPreview" class="mb-3" style="display: none;">
                        <img id="logoPreviewImg" src="" alt="Logo preview" style="max-width: 200px; max-height: 200px;">
                    </div>
                    <h6 class="mb-3 border-bottom pb-2">Basic Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="companyName" class="form-label">Company Name *</label>
                            <input type="text" class="form-control" id="companyName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="companyLegalName" class="form-label">Legal Name</label>
                            <input type="text" class="form-control" id="companyLegalName">
                        </div>
                        
                    </div>
                    
                    <div class="row">
                        
                        <div class="col-md-6 mb-3">
                            <label for="registeredAddress" class="form-label">Registered Address</label>
                            <input type="text" class="form-control" id="registeredAddress">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="companyCountry" class="form-label">Country</label>
                            <select class="form-select" id="companyCountry" onchange="loadStates(this.value)">
                                <option value="">Select Country</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="companyState" class="form-label">State</label>
                            <select class="form-select" id="companyState">
                                <option value="">Select State</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="companyCity" class="form-label">City</label>
                            <input type="text" class="form-control" id="companyCity">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="companyPincode" class="form-label">Pincode</label>
                            <input type="text" class="form-control" id="companyPincode">
                        </div>
                    </div>
                    
                    <!-- Contact Information Section -->
                    <h6 class="mb-3 border-bottom pb-2">Contact Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="companyEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="companyEmail">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="companyMobile" class="form-label">Mobile</label>
                            <input type="text" class="form-control" id="companyMobile">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="companyWebsite" class="form-label">Website</label>
                            <input type="url" class="form-control" id="companyWebsite">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="companyDomain" class="form-label">Domain</label>
                            <input type="text" class="form-control" id="companyDomain">
                        </div>
                    </div>
                    
                    <div class="row">
                        
                        <div class="col-md-6 mb-3">
                            <label for="quotationPrefix" class="form-label">Quotation Prefix</label>
                            <input type="text" class="form-control" id="quotationPrefix">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="logoUrl" class="form-label">Logo URL</label>
                        <input type="url" class="form-control" id="logoUrl">
                    </div>
                    
                    <!-- Compliance Details Section -->
                    <h6 class="mb-3 border-bottom pb-2">Compliance Details</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="companyGST" class="form-label">GST</label>
                            <input type="text" class="form-control" id="companyGST">
                        </div>
                    </div>
                    
                    <!-- Bank Details Section -->
                    <h6 class="mb-3 border-bottom pb-2">Bank Details</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="accountNumber" class="form-label">Account Number</label>
                            <input type="text" class="form-control" id="accountNumber">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="accountHolderName" class="form-label">Account Holder Name</label>
                            <input type="text" class="form-control" id="accountHolderName">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bankName" class="form-label">Bank Name *</label>
                            <select class="form-select" id="bankName" required onchange="updateIfscCode(this)">
                                <option value="">Select Bank</option>
                                <!-- Banks will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ifscCode" class="form-label">IFSC Code *</label>
                            <div class="input-group">
                                <span class="input-group-text" id="ifscPrefix">____</span>
                                <input type="text" class="form-control" id="ifscSuffix" 
                                    placeholder="7 characters" maxlength="7" 
                                    pattern="[A-Z0-9]{7}" title="7 uppercase letters or numbers"
                                    oninput="this.value = this.value.toUpperCase()">
                                <input type="hidden" id="ifscCode">
                            </div>
                            <small class="form-text text-muted">First 4 characters are bank prefix, enter remaining 7 characters</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bankBranch" class="form-label">Bank Branch</label>
                            <input type="text" class="form-control" id="bankBranch">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="bankAddress" class="form-label">Bank Address</label>
                            <input type="text" class="form-control" id="bankAddress">
                        </div>
                    </div>
                    
                    <!-- API Keys Section -->
                    <h6 class="mb-3 border-bottom pb-2">API Keys (Optional)</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="geminiApiKey" class="form-label">Gemini API Key</label>
                            <input type="password" class="form-control" id="geminiApiKey" placeholder="Leave blank to use system default">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="llamaApiKey" class="form-label">Llama API Key</label>
                            <input type="password" class="form-control" id="llamaApiKey" placeholder="Leave blank to use system default">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="geminiModel" class="form-label">Gemini Model</label>
                            <select class="form-select" id="geminiModel">
                                <option value="gemini-2.0-flash" selected>Gemini 2.0 Flash</option>
                                <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option>
                                <option value="gemini-pro">Gemini Pro</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="monthlyPageLimit" class="form-label">Monthly Page Limit</label>
                            <input type="number" class="form-control" id="monthlyPageLimit" value="1000" min="1">
                        </div>
                    </div>
                    
                    <!-- Admin Details Section -->
                    <h6 class="mb-3 border-bottom pb-2">Company Admin Details</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="companyAdminEmail" class="form-label">Admin Email *</label>
                            <input type="email" class="form-control" id="companyAdminEmail" placeholder="e.g., admin@company.com" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="companyAdminPassword" class="form-label">Password *</label>
                            <input type="password" class="form-control" id="companyAdminPassword" placeholder="At least 6 characters" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="companyAdminPasswordConfirm" class="form-label">Confirm Password *</label>
                            <input type="password" class="form-control" id="companyAdminPasswordConfirm" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Company</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="userModalLabel">Create New User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="userForm" novalidate>
                    <div class="modal-body">
                        <div class="mb-3">
    <label for="userProfilePhoto" class="form-label">Profile Photo</label>
    <input type="file" class="form-control" id="userProfilePhoto" accept="image/*">
</div>

                        <div class="mb-3">
    <label for="newUserName" class="form-label">First Name *</label>
    <input type="text" class="form-control" id="newUserName" required>
</div>
<div class="mb-3">
    <label for="newUserMiddle" class="form-label">Middle Name</label>
    <input type="text" class="form-control" id="newUserMiddle">
</div>
<div class="mb-3">
    <label for="newUserLast" class="form-label">Last Name</label>
    <input type="text" class="form-control" id="newUserLast">
</div>
<div class="mb-3">
    <label for="userGender" class="form-label">Gender</label>
    <select class="form-select" id="userGender">
        <option value="">Select</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
    </select>
</div>
<div class="mb-3">
    <label for="userDob" class="form-label">Date of Birth</label>
    <input type="date" class="form-control" id="userDob" onchange="calculateAge()">
</div>
<div class="mb-3">
    <label for="userAge" class="form-label">Age</label>
    <input type="number" class="form-control" id="userAge" readonly>
</div>
<div class="mb-3">
    <label for="userMobile" class="form-label">Mobile</label>
    <input type="text" class="form-control" id="userMobile">
</div>
<div class="mb-3">
    <label for="userDepartment" class="form-label">Department</label>
    <input type="text" class="form-control" id="userDepartment">
</div>
<div class="mb-3">
    <label for="userDesignation" class="form-label">Designation</label>
    <input type="text" class="form-control" id="userDesignation">
</div>
<div class="mb-3">
    <label for="userDoj" class="form-label">Date of Joining</label>
    <input type="date" class="form-control" id="userDoj">
</div>

                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="userPassword" class="form-label">Password *</label>
                            <input type="password" class="form-control" id="userPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="userCompany" class="form-label">Company *</label>
                            <select class="form-select" id="userCompany" required>
                                <option value="">Select Company</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="submitNewUser()">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Company Modal -->
    <!-- Edit Company Modal -->
<div class="modal fade" id="editCompanyModal" tabindex="-1" aria-labelledby="editCompanyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="editCompanyModalLabel">Edit Company</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCompanyForm" novalidate>
                <input type="hidden" id="editCompanyId">
                <div class="modal-body">
                    <!-- Basic Information Section -->
                    <div class="mb-3">
                        <label for="editCompanyLogo" class="form-label">Company Logo</label>
                        <input type="file" class="form-control" id="editCompanyLogo" accept="image/jpeg,image/png,image/gif">
                        <div class="form-text">Max file size: 1MB (JPEG, PNG, GIF)</div>
                    </div>
                    <div id="editLogoPreview" class="mb-3" style="display: none;">
                        <img id="editLogoPreviewImg" src="" alt="Logo preview" style="max-width: 200px; max-height: 200px;">
                    </div>
                    <h6 class="mb-3 border-bottom pb-2">Basic Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCompanyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="editCompanyName">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editCompanyLegalName" class="form-label">Legal Name</label>
                            <input type="text" class="form-control" id="editCompanyLegalName">
                        </div>
                        
                    </div>
                    
                    <div class="row">
                        
                        <div class="col-md-6 mb-3">
                            <label for="editRegisteredAddress" class="form-label">Registered Address</label>
                            <input type="text" class="form-control" id="editRegisteredAddress">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCompanyCountry" class="form-label">Country</label>
                            <select class="form-select" id="editCompanyCountry" onchange="loadEditStates(this.value)">
                                <option value="">Select Country</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editCompanyState" class="form-label">State</label>
                            <select class="form-select" id="editCompanyState">
                                <option value="">Select State</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editCompanyCity" class="form-label">City</label>
                            <input type="text" class="form-control" id="editCompanyCity">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editCompanyPincode" class="form-label">Pincode</label>
                            <input type="text" class="form-control" id="editCompanyPincode">
                        </div>
                    </div>
                    
                    <!-- Contact Information Section -->
                    <h6 class="mb-3 border-bottom pb-2">Contact Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCompanyEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editCompanyEmail">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editCompanyMobile" class="form-label">Mobile</label>
                            <input type="text" class="form-control" id="editCompanyMobile">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCompanyWebsite" class="form-label">Website</label>
                            <input type="url" class="form-control" id="editCompanyWebsite">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editCompanyDomain" class="form-label">Domain</label>
                            <input type="text" class="form-control" id="editCompanyDomain">
                        </div>
                    </div>
                    
                    <div class="row">
                        
                        <div class="col-md-6 mb-3">
                            <label for="editQuotationPrefix" class="form-label">Quotation Prefix</label>
                            <input type="text" class="form-control" id="editQuotationPrefix">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editLogoUrl" class="form-label">Logo URL</label>
                        <input type="url" class="form-control" id="editLogoUrl">
                    </div>
                    
                    <!-- Compliance Details Section -->
                    <h6 class="mb-3 border-bottom pb-2">Compliance Details</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editCompanyGST" class="form-label">GST</label>
                            <input type="text" class="form-control" id="editCompanyGST">
                        </div>
                    </div>
                    
                    <!-- Bank Details Section -->
                    <h6 class="mb-3 border-bottom pb-2">Bank Details</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editAccountNumber" class="form-label">Account Number</label>
                            <input type="text" class="form-control" id="editAccountNumber">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editAccountHolderName" class="form-label">Account Holder Name</label>
                            <input type="text" class="form-control" id="editAccountHolderName">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editBankName" class="form-label">Bank Name</label>
                            <select class="form-select" id="editBankName" onchange="updateEditIfscCode(this)">
                                <option value="">Select Bank</option>
                                <!-- Banks will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editIfscCode" class="form-label">IFSC Code</label>
                            <div class="input-group">
                                <span class="input-group-text" id="editIfscPrefixDisplay">____</span>
                                <input type="text" class="form-control" id="editIfscSuffix" 
                                    placeholder="7 characters" maxlength="7" 
                                    pattern="[A-Z0-9]{7}" title="7 uppercase letters or numbers"
                                    oninput="this.value = this.value.toUpperCase()">
                                <input type="hidden" id="editIfscCode">
                            </div>
                            <small class="form-text text-muted">First 4 characters are bank prefix, enter remaining 7 characters</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editBankBranch" class="form-label">Bank Branch</label>
                            <input type="text" class="form-control" id="editBankBranch">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editBankAddress" class="form-label">Bank Address</label>
                            <input type="text" class="form-control" id="editBankAddress">
                        </div>
                    </div>
                    
                    <!-- API Keys Section -->
                    <h6 class="mb-3 border-bottom pb-2">API Keys Management</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editGeminiApiKey" class="form-label">Gemini API Key</label>
                            <input type="password" class="form-control" id="editGeminiApiKey" placeholder="Leave blank to keep current">
                            <div class="form-text">Leave blank to keep current key</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editLlamaApiKey" class="form-label">Llama API Key</label>
                            <input type="password" class="form-control" id="editLlamaApiKey" placeholder="Leave blank to keep current">
                            <div class="form-text">Leave blank to keep current key</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editGeminiModel" class="form-label">Gemini Model</label>
                            <select class="form-select" id="editGeminiModel">
                                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                                <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option>
                                <option value="gemini-pro">Gemini Pro</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editMonthlyPageLimit" class="form-label">Monthly Page Limit</label>
                            <input type="number" class="form-control" id="editMonthlyPageLimit" min="1">
                        </div>
                    </div>
                    
                    <!-- Status Section -->
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div>
                            <button type="button" class="btn btn-sm btn-success me-2" onclick="updateCompanyStatus('active')">
                                <i class="fas fa-check"></i> Set Active
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="updateCompanyStatus('inactive')">
                                <i class="fas fa-times"></i> Set Inactive
                            </button>
                        </div>
                    </div>
                    
                    <!-- API Key Actions -->
                    <div class="mb-3">
                        <label class="form-label">API Key Actions</label>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="viewApiKeys()">
                                <i class="fas fa-eye"></i> View API Keys Status
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearApiKeys()">
                                <i class="fas fa-trash"></i> Clear API Keys
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editUserForm" novalidate>
                    <input type="hidden" id="editUserId">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editUserName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editUserName">
                        </div>
                        <div class="mb-3">
                            <label for="editUserEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editUserEmail">
                        </div>
                        <div class="mb-3">
                            <label for="editUserPassword" class="form-label">Password (leave blank to keep)</label>
                            <input type="password" class="form-control" id="editUserPassword">
                        </div>
                        <div class="mb-3">
                            <label for="editUserRole" class="form-label">Role</label>
                            <select class="form-select" id="editUserRole">
                                <option value="">Choose One</option>
                                <option value="company_admin">Company Admin</option>
                                <option value="user">Regular User</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editUserCompany" class="form-label">Company</label>
                            <select class="form-select" id="editUserCompany">
                                <option value="">Choose One</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="statusReason" class="form-label">Reason for status change</label>
                            <textarea id="statusReason" class="form-control" rows="2" placeholder="Enter reason..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-success me-2" onclick="updateUserStatus('active')">
                                    <i class="fas fa-check"></i> Set Active
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="updateUserStatus('inactive')">
                                    <i class="fas fa-times"></i> Set Inactive
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let userData = null;
        let companies = [];
        let currentStatusFilter = 'all';
        let currentRestoreType = 'companies';

        // Set active nav link based on current page
        function setActiveNavLink() {
            const currentPage = localStorage.getItem('currentPage') || 'dashboard';
            
            document.querySelectorAll('#sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`#sidebar .nav-link[data-page="${currentPage}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }
        async function apiFetch(url, options = {}) {
    const accessToken = localStorage.getItem("access_token");
    const refreshToken = localStorage.getItem("refresh_token");

    //  Build headers dynamically
    const headers = {
        ...options.headers,
        "Authorization": `Bearer ${accessToken}`
    };

    //  DO NOT force JSON if sending FormData
    if (!(options.body instanceof FormData)) {
        headers["Content-Type"] = options.headers?.["Content-Type"] || "application/json";
    }

    let response = await fetch(url, { ...options, headers });

    if (response.status === 401 && refreshToken) {
        const refreshRes = await fetch("http://127.0.0.1:8000/refresh", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${refreshToken}`
            }
        });

        if (refreshRes.ok) {
            const refreshData = await refreshRes.json();
            localStorage.setItem("access_token", refreshData.access_token);

            const retryHeaders = {
                ...headers,
                "Authorization": `Bearer ${refreshData.access_token}`
            };

            // Again, do not set Content-Type if body is FormData
            if (!(options.body instanceof FormData)) {
                retryHeaders["Content-Type"] = options.headers?.["Content-Type"] || "application/json";
            }

            response = await fetch(url, { ...options, headers: retryHeaders });
        } else {
            logout();
            throw new Error("Session expired. Please log in again.");
        }
    }

    return response;
}
        // Add logo upload function
        async function uploadCompanyLogo(companyId) {
            const logoFile = document.getElementById("companyLogo")?.files[0] || 
                            document.getElementById("editCompanyLogo")?.files[0];
            
            if (!logoFile) return;
            
            const formData = new FormData();
            formData.append("logo", logoFile);
            
            try {
                const response = await apiFetch(`http://127.0.0.1:8000/companies/${companyId}/logo`, {
                    method: "POST",
                    headers: {
                        "X-User-Role": "super_admin"
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result;
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || "Failed to upload logo");
                }
            } catch (error) {
                console.error("Error uploading logo:", error);
                throw error;
            }
        }

        // Update active nav link when clicking a menu item
        function updateActiveNavLink(page) {
            localStorage.setItem('currentPage', page);
            setActiveNavLink();
        }

        // Check authentication on page load
        window.onload = function() {
            const storedUserData = localStorage.getItem("userData");
            if (!storedUserData) {
                window.location.href = "index.html";
                return;
            }

            userData = JSON.parse(storedUserData);
            if (userData.role !== "super_admin") {
                window.location.href = "index.html";
                return;
            }

            document.getElementById("userName").textContent = userData.name;
            document.getElementById("userInitial").textContent = userData.name.charAt(0).toUpperCase();
            loadDashboardData();
            loadCompaniesForSelect();
            loadCountries();
        };

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            
            if (sidebar.style.width === '0px' || sidebar.style.width === '') {
                sidebar.style.width = 'var(--sidebar-width)';
                content.style.marginLeft = 'var(--sidebar-width)';
            } else {
                sidebar.style.width = '0';
                content.style.marginLeft = '0';
            }
        }

        function showDashboard() {
            updateActiveNavLink('dashboard');
            document.getElementById('dataTitle').textContent = 'Dashboard Overview';
            document.getElementById('dataFilterDropdown').style.display = 'none';
            document.getElementById('statusFilter').style.display = 'none';
            document.getElementById('dataContent').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-tachometer-alt fa-3x text-muted mb-3"></i>
                    <h5>Welcome to Super Admin Dashboard</h5>
                    <p class="text-muted">Use the sidebar to navigate to different sections</p>
                </div>
            `;
        }
        
        function showSettings() {
            updateActiveNavLink('settings');
            document.getElementById('dataTitle').textContent = 'Settings';
            document.getElementById('dataFilterDropdown').style.display = 'none';
            document.getElementById('statusFilter').style.display = 'none';
            
            const content = document.getElementById("dataContent");
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card settings-card card-primary text-white" onclick="showRestoreMenu()">
                            <div class="card-body">
                                <i class="fas fa-trash-restore card-icon"></i>
                                <h5 class="card-title">Restore</h5>
                                <p class="card-text">Restore deleted companies and users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card settings-card card-success text-white" onclick="openCompanyModal()">
                            <div class="card-body">
                                <i class="fas fa-plus-circle card-icon"></i>
                                <h5 class="card-title">Add Company</h5>
                                <p class="card-text">Create a new company</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card settings-card card-warning text-white" onclick="openUserModal()">
                            <div class="card-body">
                                <i class="fas fa-user-plus card-icon"></i>
                                <h5 class="card-title">Add User</h5>
                                <p class="card-text">Create a new user</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card settings-card card-info text-white" onclick="loadBanks()">
                            <div class="card-body">
                                <i class="fas fa-university card-icon"></i>
                                <h5 class="card-title">Bank Management</h5>
                                <p class="card-text">Manage bank details</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load countries on page load
        async function loadCountries() {
    try {
        const response = await apiFetch("http://127.0.0.1:8000/countries", {
            headers: {
                "X-User-Role": "super_admin"
            }
        });
        
        if (response.ok) {
            const countries = await response.json();
            const countrySelect = document.getElementById("companyCountry");
            const editCountrySelect = document.getElementById("editCompanyCountry");
            
            // Clear existing options
            countrySelect.innerHTML = '<option value="">Select Country</option>';
            if (editCountrySelect) editCountrySelect.innerHTML = '<option value="">Select Country</option>';
            
            // Add countries to dropdowns
            countries.forEach(country => {
                const option = document.createElement("option");
                option.value = country.id;
                option.textContent = country.name;
                countrySelect.appendChild(option);
                
                if (editCountrySelect) {
                    const editOption = document.createElement("option");
                    editOption.value = country.id;
                    editOption.textContent = country.name;
                    editCountrySelect.appendChild(editOption);
                }
            });
            
            // Set default to India
            countrySelect.value = "in";
            if (editCountrySelect) editCountrySelect.value = "in";
            
            // Load states for India
            loadStates("in");
            if (editCountrySelect) loadEditStates("in");
            
            // Load active banks for dropdowns
            loadActiveBanks();
        }
    } catch (error) {
        console.error("Error loading countries:", error);
    }
}
async function loadActiveBanks() {
    try {
        const response = await apiFetch("http://127.0.0.1:8000/banks?status=active", {
            headers: {
                "X-User-Role": "super_admin"
            }
        });
        
        if (response.ok) {
            const banks = await response.json();
            
            // Update bank dropdowns in company forms
            updateBankDropdowns(banks);
        }
    } catch (error) {
        console.error("Error loading banks:", error);
    }
}
function updateBankDropdowns(banks) {
    // Create form bank dropdown
    const bankSelect = document.getElementById("bankName");
    if (bankSelect) {
        bankSelect.innerHTML = '<option value="">Select Bank</option>';
        banks.forEach(bank => {
            const option = document.createElement("option");
            option.value = bank.bank_name;
            option.textContent = `${bank.bank_name} (${bank.ifsc_prefix})`;
            option.dataset.ifscPrefix = bank.ifsc_prefix;
            bankSelect.appendChild(option);
        });
    }
    
    // Edit form bank dropdown
    const editBankSelect = document.getElementById("editBankName");
    if (editBankSelect) {
        editBankSelect.innerHTML = '<option value="">Select Bank</option>';
        banks.forEach(bank => {
            const option = document.createElement("option");
            option.value = bank.bank_name;
            option.textContent = `${bank.bank_name} (${bank.ifsc_prefix})`;
            option.dataset.ifscPrefix = bank.ifsc_prefix;
            editBankSelect.appendChild(option);
        });
    }
}
// Update IFSC code when bank is selected
// Update IFSC code when bank is selected
function updateIfscCode(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const ifscPrefix = selectedOption?.dataset.ifscPrefix || '';
    
    // Update the prefix display
    document.getElementById('ifscPrefix').textContent = ifscPrefix || '____';
    
    // Clear the suffix input
    document.getElementById('ifscSuffix').value = '';
    
    // Enable/disable suffix input based on selection
    document.getElementById('ifscSuffix').disabled = !ifscPrefix;
}

// Update IFSC code when bank is selected in edit form
function updateEditIfscCode(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const ifscPrefix = selectedOption?.dataset.ifscPrefix || '';
    
    // Update the prefix display
    document.getElementById('editIfscPrefixDisplay').textContent = ifscPrefix || '____';
    
    // Clear the suffix input if bank changed and prefix doesn't match current IFSC
    const currentIfsc = document.getElementById('editIfscCode').value || '';
    if (ifscPrefix && currentIfsc.substring(0, 4) !== ifscPrefix) {
        document.getElementById('editIfscSuffix').value = '';
    }
    
    // Enable/disable suffix input based on selection
    document.getElementById('editIfscSuffix').disabled = !ifscPrefix;
}

// Combine prefix and suffix to create full IFSC code
function getFullIfscCode(prefixId, suffixId) {
    const prefix = document.getElementById(prefixId).textContent;
    const suffix = document.getElementById(suffixId).value.toUpperCase();
    
    if (prefix === '____' || !suffix) {
        return '';
    }
    
    return prefix + suffix;
}

// Validate IFSC code format
function validateIfscCode(ifscCode) {
    const ifscRegex = /^[A-Z]{4}0[A-Z0-9]{6}$/;
    return ifscRegex.test(ifscCode);
}
async function findBankByName(bankName) {
    try {
        const response = await apiFetch("http://127.0.0.1:8000/banks?status=active", {
            headers: {
                "X-User-Role": "super_admin"
            }
        });
        
        if (response.ok) {
            const banks = await response.json();
            const bank = banks.find(b => b.bank_name === bankName);
            return bank ? bank.ifsc_prefix : '';
        }
    } catch (error) {
        console.error("Error finding bank:", error);
    }
    return '';
}
    // Load states for create form
        async function loadStates(countryId) {
            if (!countryId) return;
            
            try {
                const response = await apiFetch(`http://127.0.0.1:8000/countries/${countryId}/states`, {
                    headers: {
                        "X-User-Role": "super_admin"
                    }
                });
                
                if (response.ok) {
                    const states = await response.json();
                    const stateSelect = document.getElementById("companyState");
                    
                    // Clear existing options
                    stateSelect.innerHTML = '<option value="">Select State</option>';
                    
                    // Add states to dropdown
                    states.forEach(state => {
                        const option = document.createElement("option");
                        option.value = state.name;
                        option.textContent = state.name;
                        stateSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error loading states:", error);
            }
        }

        // Load states for edit form
        async function loadEditStates(countryId) {
            if (!countryId) return;
            
            try {
                const response = await apiFetch(`http://127.0.0.1:8000/countries/${countryId}/states`, {
                    headers: {
                        "X-User-Role": "super_admin"
                    }
                });
                
                if (response.ok) {
                    const states = await response.json();
                    const stateSelect = document.getElementById("editCompanyState");
                    
                    // Clear existing options
                    stateSelect.innerHTML = '<option value="">Select State</option>';
                    
                    // Add states to dropdown
                    states.forEach(state => {
                        const option = document.createElement("option");
                        option.value = state.name;
                        option.textContent = state.name;
                        stateSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error loading states:", error);
            }
        }

        async function loadDashboardData() {
            try {
                const response = await apiFetch("http://127.0.0.1:8000/dashboard", {
                    headers: {
                        "X-User-Role": "super_admin"
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById("companiesCount").textContent = data.companies_count;
                    document.getElementById("usersCount").textContent = data.users_count;
                    document.getElementById("inactiveCompaniesCount").textContent = data.inactive_companies_count || 0;
                    document.getElementById("inactiveUsersCount").textContent = data.inactive_users_count || 0;
                }
            } catch (error) {
                console.error("Error loading dashboard data:", error);
            }
        }

        async function loadCompaniesForSelect() {
            try {
                const response = await apiFetch("http://127.0.0.1:8000/companies", {
                    headers: {
                        "X-User-Role": "super_admin"
                    }
                });
                
                if (response.ok) {
                    companies = await response.json();
                    const select = document.getElementById("userCompany");
                    const editSelect = document.getElementById("editUserCompany");
                    
                    select.innerHTML = '<option value="">Select Company</option>';
                    if (editSelect) editSelect.innerHTML = '<option value="">Choose One</option>';
                    
                    companies.forEach(company => {
                        const option = document.createElement("option");
                        option.value = company.id;
                        option.textContent = company.name;
                        select.appendChild(option);
                        
                        if (editSelect) {
                            const editOption = document.createElement("option");
                            editOption.value = company.id;
                            editOption.textContent = company.name;
                            editSelect.appendChild(editOption);
                        }
                    });
                }
            } catch (error) {
                console.error("Error loading companies:", error);
            }
        }

        async function loadCompanies(status = 'all') {
    updateActiveNavLink('companies');
    document.getElementById('dataTitle').textContent = 'Companies';
    document.getElementById('dataFilterDropdown').style.display = 'block';
    document.getElementById('statusFilter').style.display = 'block';
    
    try {
        let url = "http://127.0.0.1:8000/companies";
        if (status !== 'all') {
            url += `?status=${status}`;
        }
        
        const response = await apiFetch(url, {
            headers: {
                "X-User-Role": "super_admin"
            }
        });
        
        if (response.ok) {
            companies = await response.json();
            
            // Fetch usage data for each company
            const companiesWithUsage = await Promise.all(
                companies.map(async (company) => {
                    try {
                        const usageResponse = await apiFetch(`http://127.0.0.1:8000/companies/${company.id}/usage`, {
                            headers: {
                                "X-User-Role": "super_admin"
                            }
                        });
                        
                        if (usageResponse.ok) {
                            const usageData = await usageResponse.json();
                            return {
                                ...company,
                                monthly_page_limit: usageData.monthly_page_limit,
                                current_usage: usageData.current_usage
                            };
                        }
                    } catch (error) {
                        console.error(`Error fetching usage for company ${company.id}:`, error);
                    }
                    return company;
                })
            );
            
            displayCompanies(companiesWithUsage);
        }
    } catch (error) {
        showMessage("Error loading companies", "error");
    }
}
function openUsageModal(companyId, companyName) {
    // Create or show a modal for detailed usage statistics
    const modalHtml = `
        <div class="modal fade" id="usageModal" tabindex="-1" aria-labelledby="usageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="usageModalLabel">Usage Details - ${companyName}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="usageModalBody">
                        <div class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading usage data...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to DOM if it doesn't exist
    if (!document.getElementById('usageModal')) {
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('usageModal'));
    modal.show();
    
    // Load usage data
    loadCompanyUsageDetails(companyId);
}

async function loadCompanyUsageDetails(companyId) {
    try {
        const response = await apiFetch(`http://127.0.0.1:8000/companies/${companyId}/usage`, {
            headers: {
                "X-User-Role": "super_admin"
            }
        });
        
        if (response.ok) {
            const usageData = await response.json();
            
            const usagePercentage = usageData.monthly_page_limit > 0 
                ? (usageData.current_usage / usageData.monthly_page_limit) * 100 
                : 0;
            
            let progressClass = "bg-success";
            if (usagePercentage >= 75) progressClass = "bg-warning";
            if (usagePercentage >= 90) progressClass = "bg-danger";
            
            document.getElementById('usageModalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">Usage Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="border rounded p-3 text-center">
                                            <h4 class="text-primary">${usageData.current_usage.toLocaleString()}</h4>
                                            <small class="text-muted">Pages Used</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-3 text-center">
                                            <h4 class="text-success">${(usageData.monthly_page_limit - usageData.current_usage).toLocaleString()}</h4>
                                            <small class="text-muted">Pages Remaining</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Usage Progress</span>
                                        <span>${usagePercentage.toFixed(1)}%</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar ${progressClass}" role="progressbar" 
                                            style="width: ${usagePercentage}%;" 
                                            aria-valuenow="${usagePercentage}" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Update Page Limit</h6>
                            </div>
                            <div class="card-body">
                                <form id="updateLimitForm" onsubmit="updateCompanyLimit(event, '${companyId}')">
                                    
                                    <!-- Paid Amount Input -->
                                    <div class="mb-3">
                                        <label for="amountPaid" class="form-label">Enter Paid Amount ()</label>
                                        <input type="number" class="form-control" id="amountPaid" min="1" required
                                            oninput="calculatePageLimit()">
                                    </div>

                                    <!-- Page Limit (auto calculated) -->
                                    <div class="mb-3">
                                        <label for="pageLimit" class="form-label">Monthly Page Limit</label>
                                        <input type="number" class="form-control" id="pageLimit" readonly>
                                    </div>

                                    <button type="submit" class="btn btn-primary">Update Limit</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            document.getElementById('usageModalBody').innerHTML = `
                <div class="alert alert-danger">Error loading usage details</div>
            `;
        }
    } catch (error) {
        document.getElementById('usageModalBody').innerHTML = `
            <div class="alert alert-danger">Error loading usage details: ${error.message}</div>
        `;
    }
}

function calculatePageLimit() {
    const amount = parseFloat(document.getElementById("amountPaid").value) || 0;
    const pages = Math.floor(amount / 0.5); // 50 paise per page
    document.getElementById("pageLimit").value = pages;
}

async function updateCompanyLimit(event, companyId) {
    event.preventDefault();
    
    const newLimit = parseInt(document.getElementById('pageLimit').value);
    
    if (!newLimit || newLimit <= 0) {
        showMessage("Invalid page limit", "error");
        return;
    }

    try {
        const response = await apiFetch(
            `http://127.0.0.1:8000/companies/${companyId}/limit?monthly_page_limit=${newLimit}`,
            {
                method: "PATCH",
                headers: {
                    "X-User-Role": "super_admin"
                }
            }
        );

        if (response.ok) {
            showMessage("Page limit updated successfully", "success");
            loadCompanyUsageDetails(companyId);
            loadCompanies(currentStatusFilter);
        } else {
            const errorText = await response.text();
            showMessage(errorText || "Failed to update page limit", "error");
        }
    } catch (error) {
        showMessage("Error updating page limit", "error");
    }
}
        async function loadUsers(status = 'all') {
            updateActiveNavLink('users');
            document.getElementById('dataTitle').textContent = 'Users';
            document.getElementById('dataFilterDropdown').style.display = 'block';
            document.getElementById('statusFilter').style.display = 'block';
            
            try {
                let url = "http://127.0.0.1:8000/users";
                if (status !== 'all') {
                    url += `?status=${status}`;
                }
                
                const response = await apiFetch(url, {
                    headers: {
                        "X-User-Role": "super_admin"
                    }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                }
            } catch (error) {
                showMessage("Error loading users", "error");
            }
        }

        function displayCompanies(companies) {
    const content = document.getElementById("dataContent");
    if (companies.length === 0) {
        content.innerHTML = `<p class="text-muted text-center py-4">No companies found</p>`;
        return;
    }

    let html = `
        <div class="table-responsive">
            <table class="table data-table">
                <thead>
                    <tr>
                        <th>Company Name</th>
                        <th>Status</th>
                        <th>Total Pages</th>
                        <th>Used Pages</th>
                        <th>Remaining Pages</th>
                        <th>API Keys</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    companies.forEach(company => {
        const statusClass = company.status === 'active' ? 'badge-active' : 'badge-inactive';
        const hasGeminiKey = company.gemini_api_key ? 'text-success' : 'text-muted';
        const hasLlamaKey = company.llama_api_key ? 'text-success' : 'text-muted';
        
        // Calculate usage statistics
        const totalPages = company.monthly_page_limit || 1000;
        const usedPages = company.current_usage || 0;
        const remainingPages = Math.max(0, totalPages - usedPages);
        const usagePercentage = totalPages > 0 ? (usedPages / totalPages) * 100 : 0;
        
        // Determine color based on usage
        let usageClass = "text-success";
        if (usagePercentage >= 75) usageClass = "text-warning";
        if (usagePercentage >= 90) usageClass = "text-danger";
        
        html += `
            <tr>
                <td>${company.name}</td>
                
                <td><span class="badge ${statusClass}">${company.status || 'active'}</span></td>
                <td>${totalPages.toLocaleString()}</td>
                <td class="${usageClass}">${usedPages.toLocaleString()}</td>
                <td>${remainingPages.toLocaleString()}</td>
                <td>
                    <i class="fas fa-key ${hasGeminiKey}" title="Gemini API Key"></i>
                    <i class="fas fa-key ${hasLlamaKey}" title="Llama API Key"></i>
                </td>
                <td>${new Date(company.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick='openEditCompanyModal(${JSON.stringify(company)})'>
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-warning" onclick='openUsageModal("${company.id}", "${company.name}")'>
                        <i class="fas fa-chart-pie"></i> Usage
                    </button>
                    <button class="btn btn-sm btn-danger" onclick='confirmDeleteCompany("${company.id}")'>
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });

    html += "</tbody></table></div>";
    content.innerHTML = html;
}

        function displayUsers(users) {
            const content = document.getElementById("dataContent");
            if (users.length === 0) {
                content.innerHTML = `<p class="text-muted text-center py-4">No users found</p>`;
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Company</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            users.forEach(user => {
                const company = companies.find(c => c.id === user.company_id);
                const badgeClass = user.role === 'company_admin' ? 'badge-admin' : 'badge-user';
                const statusClass = user.status === 'active' ? 'badge-active' : 'badge-inactive';
                
                html += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="badge ${badgeClass}">${user.role}</span></td>
                        <td><span class="badge ${statusClass}">${user.status || 'active'}</span></td>
                        <td>${company ? company.name : 'Unknown'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick='openEditUserModal(${JSON.stringify(user)})'>
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick='confirmDeleteUser("${user.id}")'>
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += "</tbody></table></div>";
            content.innerHTML = html;
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            
            // Update button states
            document.querySelectorAll('#statusFilter .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#statusFilter .btn:nth-child(${status === 'all' ? 1 : status === 'active' ? 2 : 3})`).classList.add('active');
            
            // Reload data based on current page
            const currentPage = localStorage.getItem('currentPage');
            if (currentPage === 'companies') {
                loadCompanies(status);
            } else if (currentPage === 'users') {
                loadUsers(status);
            }
        }

        function showRestoreMenu() {
            updateActiveNavLink('restore');
            document.getElementById('dataTitle').textContent = 'Restore Deleted Items';
            document.getElementById('dataFilterDropdown').style.display = 'none';
            document.getElementById('statusFilter').style.display = 'none';
            
            const content = document.getElementById("dataContent");
            content.innerHTML = `
                <div class="restore-section">
                    
                    <p class="text-muted">Select the type of items you want to restore</p>
                    
                    <ul class="nav nav-tabs" id="restoreTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="companies-tab" data-bs-toggle="tab" data-bs-target="#companies-tab-pane" type="button" role="tab" aria-controls="companies-tab-pane" aria-selected="true" onclick="loadDeletedCompanies()">
                                <i class="fas fa-building"></i> Companies
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-tab-pane" type="button" role="tab" aria-controls="users-tab-pane" aria-selected="false" onclick="loadDeletedUsers()">
                                <i class="fas fa-users"></i> Users
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="restoreTabContent">
                        <div class="tab-pane fade show active" id="companies-tab-pane" role="tabpanel" aria-labelledby="companies-tab" tabindex="0">
                            <div id="deletedCompaniesContent" class="py-3">
                                <p class="text-muted text-center">Loading deleted companies...</p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="users-tab-pane" role="tabpanel" aria-labelledby="users-tab" tabindex="0">
                            <div id="deletedUsersContent" class="py-3">
                                <p class="text-muted text-center">Loading deleted users...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load deleted companies by default
            loadDeletedCompanies();
        }

        async function loadDeletedCompanies() {
            try {
                const response = await apiFetch("http://127.0.0.1:8000/deleted/companies", {
                    headers: {
                        "X-User-Role": "super_admin"
                    }
                });
                
                if (response.ok) {
                    const deletedCompanies = await response.json();
                    displayDeletedCompanies(deletedCompanies);
                }
            } catch (error) {
                document.getElementById("deletedCompaniesContent").innerHTML = `
                    <div class="alert alert-danger">Error loading deleted companies: ${error.message}</div>
                `;
            }
        }

        async function loadDeletedUsers() {
            try {
                const response = await apiFetch("http://127.0.0.1:8000/deleted/users", {
                    headers: {
                        "X-User-Role": "super_admin"
                    }
                });
                
                if (response.ok) {
                    const deletedUsers = await response.json();
                    displayDeletedUsers(deletedUsers);
                }
            } catch (error) {
                document.getElementById("deletedUsersContent").innerHTML = `
                    <div class="alert alert-danger">Error loading deleted users: ${error.message}</div>
                `;
            }
        }

        function displayDeletedCompanies(companies) {
            const content = document.getElementById("deletedCompaniesContent");
            if (companies.length === 0) {
                content.innerHTML = `<p class="text-muted text-center py-4">No deleted companies found</p>`;
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table data-table">
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Description</th>
                                <th>Address</th>
                                <th>Deleted At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            companies.forEach(company => {
                html += `
                    <tr>
                        <td>${company.name}</td>
                        <td>${company.description || '-'}</td>
                        <td>${company.address || '-'}</td>
                        <td>${company.deleted_at ? new Date(company.deleted_at).toLocaleDateString() : 'Unknown'}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick='restoreCompany("${company.id}")'>
                                <i class="fas fa-trash-restore"></i> Restore
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += "</tbody></table></div>";
            content.innerHTML = html;
        }

        function displayDeletedUsers(users) {
            const content = document.getElementById("deletedUsersContent");
            if (users.length === 0) {
                content.innerHTML = `<p class="text-muted text-center py-4">No deleted users found</p>`;
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Company</th>
                                <th>Deleted At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            users.forEach(user => {
                const company = companies.find(c => c.id === user.company_id);
                const badgeClass = user.role === 'company_admin' ? 'badge-admin' : 'badge-user';
                
                html += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="badge ${badgeClass}">${user.role}</span></td>
                        <td>${company ? company.name : 'Unknown'}</td>
                        <td>${user.deleted_at ? new Date(user.deleted_at).toLocaleDateString() : 'Unknown'}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick='restoreUser("${user.id}")'>
                                <i class="fas fa-trash-restore"></i> Restore
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += "</tbody></table></div>";
            content.innerHTML = html;
        }

        async function restoreCompany(companyId) {
            if (!confirm("Are you sure you want to restore this company?")) return;
            
            try {
                const response = await apiFetch(`http://127.0.0.1:8000/companies/${companyId}/restore`, {
                    method: "POST",
                    headers: {
                        "X-User-Role": "super_admin"
                    }
                });
                
                if (response.ok) {
                    showMessage("Company restored successfully", "success");
                    loadDeletedCompanies();
                    loadDashboardData();
                } else {
                    const errorText = await response.text();
                    showMessage(errorText || "Failed to restore company", "error");
                }
            } catch (error) {
                showMessage("Error restoring company", "error");
            }
        }

        async function restoreUser(userId) {
            if (!confirm("Are you sure you want to restore this user?")) return;
            
            try {
                const response = await apiFetch(`http://127.0.0.1:8000/users/${userId}/restore`, {
                    method: "POST",
                    headers: {
                        "X-User-Role": "super_admin"
                    }
                });
                
                if (response.ok) {
                    showMessage("User restored successfully", "success");
                    loadDeletedUsers();
                    loadDashboardData();
                } else {
                    const errorText = await response.text();
                    showMessage(errorText || "Failed to restore user", "error");
                }
            } catch (error) {
                showMessage("Error restoring user", "error");
            }
        }

        // Modal functions
        function openCompanyModal() {
            updateActiveNavLink('add-company');
            const modal = new bootstrap.Modal(document.getElementById('companyModal'));
            modal.show();
        }

        function closeCompanyModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('companyModal'));
            modal.hide();
            document.getElementById("companyForm").reset();
        }

        function openUserModal() {
            updateActiveNavLink('add-user');
            if (!companies || companies.length === 0) {
                loadCompaniesForSelect();
                showMessage("Loading companies. Please try again in a moment.", "error");
                return;
            }
            const companySelect = document.getElementById("userCompany");
            if (companySelect && (!companySelect.value || companySelect.value === "")) {
                companySelect.value = companies[0]?.id || "";
            }
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        function closeUserModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
            modal.hide();
            document.getElementById("userForm").reset();
        }

        // View API keys status
        async function viewApiKeys() {
            const companyId = document.getElementById("editCompanyId").value;
            if (!companyId) {
                showMessage("No company selected", "error");
                return;
            }

            try {
                const response = await apiFetch(`http://127.0.0.1:8000/companies/${companyId}/api-keys`, {
                    headers: {
                        "X-User-Role": "super_admin"
                    }
                });
                
                if (response.ok) {
                    const apiKeys = await response.json();
                    showMessage(
                        `API Keys Status for ${apiKeys.company_name}:<br>` +
                        `- Gemini Key: ${apiKeys.has_gemini_key ? 'Set' : 'Not Set'}<br>` +
                        `- Llama Key: ${apiKeys.has_llama_key ? 'Set' : 'Not Set'}<br>` +
                        `- Model: ${apiKeys.gemini_model}`,
                        "info"
                    );
                } else {
                    showMessage("Failed to fetch API keys status", "error");
                }
            } catch (error) {
                showMessage("Error fetching API keys status", "error");
            }
        }

        // Clear API keys
        async function clearApiKeys() {
            const companyId = document.getElementById("editCompanyId").value;
            if (!companyId) {
                showMessage("No company selected", "error");
                return;
            }

            if (!confirm("Are you sure you want to clear all API keys for this company?")) return;

            try {
                const response = await apiFetch(`http://127.0.0.1:8000/companies/${companyId}/api-keys`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-User-Role": "super_admin"
                    },
                    body: "gemini_api_key=&llama_api_key="
                });
                
                if (response.ok) {companyAddress
                    showMessage("API keys cleared successfully", "success");
                } else {
                    showMessage("Failed to clear API keys", "error");
                }
            } catch (error) {
                showMessage("Error clearing API keys", "error");
            }
        }

        // Form submissions
document.getElementById("companyForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    
    const name = (document.getElementById("companyName").value || "").trim();
    const legal_name = (document.getElementById("companyLegalName").value || "").trim();
    const admin_email = (document.getElementById("companyAdminEmail").value || "").trim();
    const admin_password = (document.getElementById("companyAdminPassword").value || "").trim();
    const admin_password_confirm = (document.getElementById("companyAdminPasswordConfirm").value || "").trim();
    const geminiApiKey = document.getElementById("geminiApiKey").value.trim();
    const llamaApiKey = document.getElementById("llamaApiKey").value.trim();
    const geminiModel = document.getElementById("geminiModel").value;
    const monthlyPageLimit = parseInt(document.getElementById("monthlyPageLimit").value) || 1000;
    
    
    // New fields
    const logo_url = document.getElementById("logoUrl").value.trim();
    const email = document.getElementById("companyEmail").value.trim();
    const mobile = document.getElementById("companyMobile").value.trim();
    const website = document.getElementById("companyWebsite").value.trim();
    const domain = document.getElementById("companyDomain").value.trim();
    const country = (document.getElementById("companyCountry").value || "").trim();
    const state = (document.getElementById("companyState").value || "").trim();
    const city = document.getElementById("companyCity").value.trim();
    const pincode = document.getElementById("companyPincode").value.trim();
    const quotation_prefix = document.getElementById("quotationPrefix").value.trim();
    const registered_address = document.getElementById("registeredAddress").value.trim();
    
    // Compliance details
    const gst = document.getElementById("companyGST").value.trim();
    
    // Bank details - Get these values FIRST
    const bankName = document.getElementById("bankName").value;
    const ifscCode = getFullIfscCode('ifscPrefix', 'ifscSuffix');
    const account_number = document.getElementById("accountNumber").value.trim();
    const account_holder_name = document.getElementById("accountHolderName").value.trim();
    const bank_branch = document.getElementById("bankBranch").value.trim();
    const bank_address = document.getElementById("bankAddress").value.trim();

    const missing = [];
    if (!name) missing.push("company name");
    if (!admin_email) missing.push("admin email");
    if (!admin_password) missing.push("admin password");
    if (!admin_password_confirm) missing.push("confirm password");
    if (missing.length) {
        showMessage("Please fill required fields: " + missing.join(", "), "error");
        return;
    }
    if (admin_password.length < 6) {
        showMessage("Admin password must be at least 6 characters.", "error");
        return;
    }
    if (admin_password !== admin_password_confirm) {
        showMessage("Passwords do not match.", "error");
        return;
    }
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(admin_email)) {
        showMessage("Please enter a valid admin email.", "error");
        return;
    }

    // Add validation for bank details
    if (bankName && (!ifscCode || !account_number || !account_holder_name)) {
        showMessage("Please complete all required bank details", "error");
        return;
    }

    if (ifscCode && !validateIfscCode(ifscCode)) {
        showMessage("Invalid IFSC code format. It should be 4 letters + 0 + 6 letters/numbers", "error");
        return;
    }

    // Client-side duplicate check
    try {
        const listRes = await apiFetch("http://127.0.0.1:8000/companies", {
            headers: { "X-User-Role": "super_admin" }
        });
        if (listRes.ok) {
            const list = await listRes.json();
            const nameExists = (list || []).some(c => (c.name || '').trim().toLowerCase() === name.toLowerCase());
            if (nameExists) {
                showMessage("Company name already exists.", "error");
                return;
            }
        }
    } catch {}

    // Admin email duplicate check
    try {
        const usersRes = await apiFetch("http://127.0.0.1:8000/users", {
            headers: { "X-User-Role": "super_admin" }
        });
        if (usersRes.ok) {
            const users = await usersRes.json();
            const emailExists = (users || []).some(u => (u.email || '').trim().toLowerCase() === admin_email.toLowerCase());
            if (emailExists) {
                showMessage("Admin email already exists.", "error");
                return;
            }
        }
    } catch {}

    // Initialize companyData AFTER getting all form values
    const companyData = { 
        name, 
        legal_name: legal_name || undefined,
        admin_email, 
        admin_password,
        gemini_api_key: geminiApiKey || undefined, 
        llama_api_key: llamaApiKey || undefined, 
        gemini_model: geminiModel,
        monthly_page_limit: monthlyPageLimit,
        
        // New fields
        logo_url: logo_url || undefined,
        email: email || undefined,
        mobile: mobile || undefined,
        website: website || undefined,
        domain: domain || undefined,
        country: country || undefined,
        state: state || undefined,
        city: city || undefined,
        pincode: pincode || undefined,
        quotation_prefix: quotation_prefix || undefined,
        registered_address: registered_address || undefined,
        
        // Compliance details
        gst: gst || undefined,
        
        // Bank details - Add these to companyData
        bank_name: bankName || undefined,
        ifsc_code: ifscCode || undefined,
        account_number: account_number || undefined,
        account_holder_name: account_holder_name || undefined,
        bank_branch: bank_branch || undefined,
        bank_address: bank_address || undefined
    };

    // ... rest of the code remains the same ...
    try {
        const response = await apiFetch("http://127.0.0.1:8000/companies", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-User-Role": "super_admin"
            },
            body: JSON.stringify(companyData)
        });

        if (response.ok) {
            const company = await response.json();
            
            // Upload logo if selected
            const logoFile = document.getElementById("companyLogo").files[0];
            if (logoFile) {
                await uploadCompanyLogo(company.id);
            }
            
            showMessage("Company created successfully!", "success");
            closeCompanyModal();
            loadDashboardData();
            loadCompaniesForSelect();
        } else {
            const errorText = await response.text();
            showMessage(errorText || "Failed to create company", "error");
        }
    } catch (error) {
        showMessage("Error creating company", "error");
    }
});

        function calculateAge() {
    const dobInput = document.getElementById("userDob");
    const ageInput = document.getElementById("userAge");
    if (!dobInput.value) { ageInput.value = ""; return; }
    const dob = new Date(dobInput.value);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
    ageInput.value = age;
}

async function submitNewUser() {
    const name = document.getElementById("newUserName").value.trim();
    const middle_name = document.getElementById("newUserMiddle").value.trim();
    const last_name = document.getElementById("newUserLast").value.trim();
    const gender = document.getElementById("userGender").value;
    const dob = document.getElementById("userDob").value;
    const age = document.getElementById("userAge").value;
    const mobile = document.getElementById("userMobile").value.trim();
    const department = document.getElementById("userDepartment").value.trim();
    const designation = document.getElementById("userDesignation").value.trim();
    const date_of_joining = document.getElementById("userDoj").value;

    const email = document.getElementById("userEmail").value.trim();
    const password = document.getElementById("userPassword").value.trim();
    const company_id = document.getElementById("userCompany").value.trim();
    const role = "user";

    // Basic validation same as before...
    if (!name || !email || !password || !company_id) {
        showMessage("Please fill required fields.", "error");
        return;
    }

    const payload = {
        name, middle_name, last_name, gender,
        dob: dob || null,
        age: age ? parseInt(age) : null,
        mobile, department, designation,
        date_of_joining: date_of_joining || null,
        email, password, role, company_id
    };

    const res = await apiFetch(`http://127.0.0.1:8000/users`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-User-Role": "super_admin"
        },
        body: JSON.stringify(payload)
    });

    if (res.ok) {
        const data = await res.json();
        const userId = data.id;

        // Upload profile photo if selected
        const fileInput = document.getElementById("userProfilePhoto");
        if (fileInput.files.length > 0) {
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            const photoRes = await apiFetch(`http://127.0.0.1:8000/users/${userId}/profile-photo`, {
                method: "POST",
                body: formData
            });
            if (!photoRes.ok) {
                console.warn("Profile photo upload failed");
            }
        }
        showMessage("User created successfully!", "success");
        closeUserModal();
        loadDashboardData();
    } else {
        const err = await res.text();
        showMessage(err, "error");
    }
}


        // Populate edit company modal
        function openEditCompanyModal(company) {
    document.getElementById("editCompanyId").value = company.id;
    document.getElementById("editCompanyName").value = company.name || "";
    document.getElementById("editCompanyLegalName").value = company.legal_name || "";
    document.getElementById("editRegisteredAddress").value = company.registered_address || "";
    document.getElementById("editCompanyCountry").value = "in"; // Default to India
    document.getElementById("editCompanyState").value = company.state || "";
    document.getElementById("editCompanyCity").value = company.city || "";
    document.getElementById("editCompanyPincode").value = company.pincode || "";
    document.getElementById("editCompanyEmail").value = company.email || "";
    document.getElementById("editCompanyMobile").value = company.mobile || "";
    document.getElementById("editCompanyWebsite").value = company.website || "";
    document.getElementById("editCompanyDomain").value = company.domain || "";
    document.getElementById("editQuotationPrefix").value = company.quotation_prefix || "";
    document.getElementById("editLogoUrl").value = company.logo_url || "";
    
    // Compliance details
    document.getElementById("editCompanyGST").value = company.gst || "";
    
    // Bank details
    const bankSelect = document.getElementById("editBankName");
    if (bankSelect && company.bank_name) {
        // Wait for banks to load
        setTimeout(() => {
            for (let i = 0; i < bankSelect.options.length; i++) {
                if (bankSelect.options[i].value === company.bank_name) {
                    bankSelect.selectedIndex = i;
                    updateEditIfscCode(bankSelect);
                    break;
                }
            }
            
            if (company.bank_name && bankSelect.value !== company.bank_name) {
                findBankByName(company.bank_name).then(ifscPrefix => {
                    if (ifscPrefix) {
                        const option = document.createElement("option");
                        option.value = company.bank_name;
                        option.textContent = `${company.bank_name} (${ifscPrefix})`;
                        option.dataset.ifscPrefix = ifscPrefix;
                        option.selected = true;
                        bankSelect.appendChild(option);
                        updateEditIfscCode(bankSelect);
                    }
                });
            }
        }, 100);
    }

    // Pre-fill IFSC code if exists
    if (company.ifsc_code) {
        const ifscPrefix = company.ifsc_code.substring(0, 4);
        const ifscSuffix = company.ifsc_code.substring(4);
        
        document.getElementById('editIfscPrefixDisplay').textContent = ifscPrefix;
        document.getElementById('editIfscSuffix').value = ifscSuffix;
        document.getElementById('editIfscCode').value = company.ifsc_code;
    }

    // Pre-fill other bank details
    document.getElementById("editAccountNumber").value = company.account_number || "";
    document.getElementById("editAccountHolderName").value = company.account_holder_name || "";
    document.getElementById("editBankBranch").value = company.bank_branch || "";
    document.getElementById("editBankAddress").value = company.bank_address || "";
    
    // API key fields
    document.getElementById("editGeminiApiKey").value = "";
    document.getElementById("editLlamaApiKey").value = "";
    document.getElementById("editGeminiModel").value = company.gemini_model || "gemini-2.0-flash";
    document.getElementById("editMonthlyPageLimit").value = company.monthly_page_limit || 1000;
    
    // Logo preview - FIXED
    if (company.logo_url) {
        const logoUrl = company.logo_url.startsWith('http') ? company.logo_url : `http://127.0.0.1:8000${company.logo_url}`;
        document.getElementById("editLogoPreviewImg").src = logoUrl;
        document.getElementById("editLogoPreview").style.display = "block";
    } else {
        document.getElementById("editLogoPreview").style.display = "none";
    }
    
    // Add logo upload event listener - FIXED
    const logoInput = document.getElementById("editCompanyLogo");
    if (logoInput) {
        logoInput.onchange = function(e) {
            handleLogoPreview(e, "editLogoPreviewImg", "editLogoPreview");
        };
    }
    
    const modal = new bootstrap.Modal(document.getElementById('editCompanyModal'));
    modal.show();
}
        function closeEditCompanyModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editCompanyModal'));
            modal.hide();
            document.getElementById("editCompanyForm").reset();
        }

        // Populate edit user modal
        function openEditUserModal(user) {
            document.getElementById("editUserId").value = user.id;
            document.getElementById("editUserName").value = user.name || "";
            document.getElementById("editUserEmail").value = user.email || "";
            document.getElementById("editUserPassword").value = "";
            document.getElementById("editUserRole").value = user.role || "";

            const companySelect = document.getElementById("editUserCompany");
            companySelect.innerHTML = '<option value="">Choose One</option>';
            companies.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.id; opt.textContent = c.name;
                companySelect.appendChild(opt);
            });
            if (user.company_id) {
                companySelect.value = user.company_id;
            }
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }
        function closeEditUserModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
            document.getElementById("editUserForm").reset();
        }

        // Update company status
        async function updateCompanyStatus(status) {
            const companyId = document.getElementById("editCompanyId").value;
            if (!companyId) {
                showMessage("No company selected", "error");
                return;
            }

            try {
                const response = await apiFetch(`http://127.0.0.1:8000/companies/${companyId}/status?status=${status}`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "X-User-Role": "super_admin"
                    }
                });

                if (response.ok) {
                    showMessage(`Company status updated to ${status}`, "success");
                    closeEditCompanyModal();
                    loadCompanies(currentStatusFilter);
                    loadDashboardData();
                } else {
                    const errorText = await response.text();
                    showMessage(errorText || "Failed to update company status", "error");
                }
            } catch (error) {
                showMessage("Error updating company status", "error");
            }
        }

        // Update user status
        async function updateUserStatus(status) {
    const userId = document.getElementById("editUserId").value;
    const reason = document.getElementById("statusReason").value.trim();

    if (!userId) {
        showMessage("No user selected", "error");
        return;
    }

    if (!reason) {
        showMessage("Please provide a reason for status change", "error");
        return;
    }

    try {
        const response = await apiFetch(`http://127.0.0.1:8000/users/${userId}/status`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "X-User-Role": "super_admin"
            },
            body: JSON.stringify({
                status: status,
                reason: reason
            })
        });

        if (response.ok) {
            showMessage(`User status updated to ${status}`, "success");
            closeEditUserModal();
            loadUsers(currentStatusFilter);
            loadDashboardData();
        } else {
            const errorText = await response.text();
            showMessage(errorText || "Failed to update user status", "error");
        }
    } catch (error) {
        showMessage("Error updating user status", "error");
    }
}


        // Save company edits
        document.getElementById("editCompanyForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const id = document.getElementById("editCompanyId").value;
            const payload = {};
            
            // Basic fields
            const n = document.getElementById("editCompanyName").value.trim();

            if (n) payload.name = n;
            
            // New fields
            const logo_url = document.getElementById("editLogoUrl").value.trim();
            const email = document.getElementById("editCompanyEmail").value.trim();
            const mobile = document.getElementById("editCompanyMobile").value.trim();
            const website = document.getElementById("editCompanyWebsite").value.trim();
            const domain = document.getElementById("editCompanyDomain").value.trim();
            const country = (document.getElementById("companyCountry").value || "").trim();
            const state = (document.getElementById("editCompanyState").value || "").trim();
            const city = document.getElementById("editCompanyCity").value.trim();
            const pincode = document.getElementById("editCompanyPincode").value.trim();
            const quotation_prefix = document.getElementById("editQuotationPrefix").value.trim();
            const registered_address = document.getElementById("editRegisteredAddress").value.trim();
            
            // Compliance details
            const gst = document.getElementById("editCompanyGST").value.trim();
            
            
            // In the editCompanyForm submit event listener, update bank data handling:
            const bankName = document.getElementById("editBankName").value;
            const ifscCode = getFullIfscCode('editIfscPrefixDisplay', 'editIfscSuffix');
            const account_number = document.getElementById("editAccountNumber").value.trim();
            const account_holder_name = document.getElementById("editAccountHolderName").value.trim();
            const bank_branch = document.getElementById("editBankBranch").value.trim();
            const bank_address = document.getElementById("editBankAddress").value.trim();
                        
            // API key fields
            const geminiKey = document.getElementById("editGeminiApiKey").value.trim();
            const llamaKey = document.getElementById("editLlamaApiKey").value.trim();
            const geminiModel = document.getElementById("editGeminiModel").value;
            const monthlyPageLimit = parseInt(document.getElementById("editMonthlyPageLimit").value) || undefined;
            
            if (logo_url !== "") payload.logo_url = logo_url;
            if (email !== "") payload.email = email;
            if (mobile !== "") payload.mobile = mobile;
            if (website !== "") payload.website = website;
            if (domain !== "") payload.domain = domain;
            if (country !== "") payload.country = country;
            if (state !== "") payload.state = state;
            if (city !== "") payload.city = city;
            if (pincode !== "") payload.pincode = pincode;
            if (quotation_prefix !== "") payload.quotation_prefix = quotation_prefix;
            if (registered_address !== "") payload.registered_address = registered_address;
            
            if (gst !== "") payload.gst = gst;
            // Add validation for bank details
            if (bankName && (!ifscCode || !account_number || !account_holder_name)) {
                showMessage("Please complete all required bank details", "error");
                return;
            }

            if (ifscCode && !validateIfscCode(ifscCode)) {
                showMessage("Invalid IFSC code format. It should be 4 letters + 0 + 6 letters/numbers", "error");
                return;
            }

            // Add to payload - store bank name instead of ID
            if (bankName) payload.bank_name = bankName;
            if (ifscCode) payload.ifsc_code = ifscCode;
            if (account_number) payload.account_number = account_number;
            if (account_holder_name) payload.account_holder_name = account_holder_name;
            if (bank_branch) payload.bank_branch = bank_branch;
            if (bank_address) payload.bank_address = bank_address;
            
            if (geminiKey !== "") payload.gemini_api_key = geminiKey;
            if (llamaKey !== "") payload.llama_api_key = llamaKey;
            if (geminiModel) payload.gemini_model = geminiModel;
            if (monthlyPageLimit) payload.monthly_page_limit = monthlyPageLimit;
            
            if (Object.keys(payload).length === 0) {
                showMessage("Nothing to update", "error");
                return;
            }
            try {
                // First update company details
                const res = await apiFetch(`http://127.0.0.1:8000/companies/${id}`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "X-User-Role": "super_admin"
                    },
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    // Then upload logo if selected
                    const logoFile = document.getElementById("editCompanyLogo").files[0];
                    if (logoFile) {
                        try {
                            await uploadCompanyLogo(id);
                        } catch (error) {
                            console.warn("Logo upload failed, but company details were updated:", error);
                            // Continue with success message even if logo upload fails
                        }
                    }
                    
                    showMessage("Company updated successfully!", "success");
                    closeEditCompanyModal();
                    loadCompanies();
                    loadCompaniesForSelect();
                } else {
                    const t = await res.text();
                    showMessage(t || "Failed to update company", "error");
                }
            } catch (error) {
                showMessage("Error updating company: " + error.message, "error");
            }
        });

        // Save user edits
        document.getElementById("editUserForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const id = document.getElementById("editUserId").value;
            const payload = {};
            const n = document.getElementById("editUserName").value.trim();
            const em = document.getElementById("editUserEmail").value.trim();
            const pw = document.getElementById("editUserPassword").value.trim();
            const rl = document.getElementById("editUserRole").value.trim();
            const co = document.getElementById("editUserCompany").value.trim();
            if (n) payload.name = n;
            if (em) payload.email = em;
            if (pw) payload.password = pw;
            if (rl) payload.role = rl;
            if (co) payload.company_id = co;
            if (Object.keys(payload).length === 0) {
                showMessage("Nothing to update", "error");
                return;
            }
            const res = await apiFetch(`http://127.0.0.1:8000/users/${id}`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    "X-User-Role": "super_admin"
                },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                showMessage("User updated", "success");
                closeEditUserModal();
                loadUsers();
            } else {
                const t = await res.text();
                showMessage(t || "Failed to update user", "error");
            }
        });

        // Deletes
        async function confirmDeleteCompany(id) {
            if (!confirm("Delete this company? This cannot be undone.")) return;
            const res = await apiFetch(`http://127.0.0.1:8000/companies/${id}`, {
                method: "DELETE",
                headers: { "X-User-Role": "super_admin" }
            });
            if (res.ok) {
                showMessage("Company deleted", "success");
                loadCompanies();
                loadCompaniesForSelect();
            } else {
                const t = await res.text();
                showMessage(t || "Failed to delete company", "error");
            }
        }
        async function confirmDeleteUser(id) {
            if (!confirm("Delete this user? This cannot be undone.")) return;
            const res = await apiFetch(`http://127.0.0.1:8000/users/${id}`, {
                method: "DELETE",
                headers: { "X-User-Role": "super_admin" }
            });
            if (res.ok) {
                showMessage("User deleted", "success");
                loadUsers();
            } else {
                const t = await res.text();
                showMessage(t || "Failed to delete user", "error");
            }
        }
        // Add this function to load banks
async function loadBanks(status = 'all') {
    updateActiveNavLink('banks');
    document.getElementById('dataTitle').textContent = 'Bank Management';
    document.getElementById('dataFilterDropdown').style.display = 'block';
    document.getElementById('statusFilter').style.display = 'block';
    
    try {
        let url = "http://127.0.0.1:8000/banks";
        if (status !== 'all') {
            url += `?status=${status}`;
        }
        
        const response = await apiFetch(url, {
            headers: {
                "X-User-Role": "super_admin"
            }
        });
        
        if (response.ok) {
            const banks = await response.json();
            displayBanks(banks);
        }
    } catch (error) {
        showMessage("Error loading banks", "error");
    }
}

function displayBanks(banks) {
    const content = document.getElementById("dataContent");
    
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Banks</h5>
            <button class="btn btn-primary" onclick="openBankModal()">
                <i class="fas fa-plus"></i> Add New Bank
            </button>
        </div>
    `;
    
    if (banks.length === 0) {
        html += `<p class="text-muted text-center py-4">No banks found</p>`;
        content.innerHTML = html;
        return;
    }

    html += `
        <div class="table-responsive">
            <table class="table data-table">
                <thead>
                    <tr>
                        <th>Bank Name</th>
                        <th>Short Name</th>
                        <th>IFSC Prefix</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    banks.forEach(bank => {
        const statusClass = bank.status === 'active' ? 'badge-active' : 'badge-inactive';
        const statusText = bank.status === 'active' ? 'Active' : 'Inactive';
        
        html += `
            <tr>
                <td>${bank.bank_name}</td>
                <td>${bank.short_name}</td>
                <td>${bank.ifsc_prefix}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>${new Date(bank.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-sm btn-info me-2" onclick='openEditBankModal(${JSON.stringify(bank)})'>
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    ${bank.status === 'active' ? 
                        `<button class="btn btn-sm btn-warning" onclick='updateBankStatus("${bank.id}", "inactive")'>
                            <i class="fas fa-times"></i> Deactivate
                        </button>` : 
                        `<button class="btn btn-sm btn-success" onclick='updateBankStatus("${bank.id}", "active")'>
                            <i class="fas fa-check"></i> Activate
                        </button>`
                    }
                </td>
            </tr>
        `;
    });

    html += "</tbody></table></div>";
    content.innerHTML = html;
}

function openBankModal() {
    // Remove existing modal if any
    const existingModal = document.getElementById('bankModal');
    if (existingModal) {
        existingModal.remove();
    }

    const modalHtml = `
        <div class="modal fade" id="bankModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Add New Bank</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="bankName" class="form-label">Bank Name *</label>
                            <input type="text" class="form-control" id="bankName">
                        </div>
                        <div class="mb-3">
                            <label for="shortName" class="form-label">Short Name *</label>
                            <input type="text" class="form-control" id="shortName">
                        </div>
                        <div class="mb-3">
                            <label for="ifscPrefix" class="form-label">IFSC Prefix *</label>
                            <input type="text" class="form-control" id="ifscPrefix">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="createBank()">Create Bank</button>
                    </div>
                </div>
            </div>
        </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('bankModal'));
    modal.show();
    
    // Focus on the first input field when modal opens
    setTimeout(() => {
        document.getElementById('bankName')?.focus();
    }, 500);
}

async function createBank() {
    // Get the modal element to ensure we're accessing the right inputs
    const modal = document.getElementById('bankModal');
    if (!modal) {
        showMessage("Bank modal not found", "error");
        return;
    }
    
    // Get inputs from within the modal context
    const bankName = modal.querySelector("#bankName")?.value.trim() || "";
    const shortName = modal.querySelector("#shortName")?.value.trim() || "";
    const ifscPrefix = modal.querySelector("#ifscPrefix")?.value.trim() || "";
    
    console.log("Form values:", {bankName, shortName, ifscPrefix});
    
    // Check if any required field is empty
    if (!bankName) {
        showMessage("Bank Name is required", "error");
        modal.querySelector("#bankName")?.focus();
        return;
    }
    if (!shortName) {
        showMessage("Short Name is required", "error");
        modal.querySelector("#shortName")?.focus();
        return;
    }
    if (!ifscPrefix) {
        showMessage("IFSC Prefix is required", "error");
        modal.querySelector("#ifscPrefix")?.focus();
        return;
    }
    
    try {
        const response = await apiFetch("http://127.0.0.1:8000/banks", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-User-Role": "super_admin"
            },
            body: JSON.stringify({
                bank_name: bankName,
                short_name: shortName,
                ifsc_prefix: ifscPrefix
            })
        });
        
        if (response.ok) {
            showMessage("Bank created successfully", "success");
            const bsModal = bootstrap.Modal.getInstance(document.getElementById('bankModal'));
            bsModal.hide();
            loadBanks(currentStatusFilter);
        } else {
            const errorText = await response.text();
            showMessage(errorText || "Failed to create bank", "error");
        }
    } catch (error) {
        showMessage("Error creating bank: " + error.message, "error");
    }
}

function openEditBankModal(bank) {
    // Remove existing modal if any
    const existingModal = document.getElementById('editBankModal');
    if (existingModal) {
        existingModal.remove();
    }

    const modalHtml = `
        <div class="modal fade" id="editBankModal" tabindex="-1" aria-labelledby="editBankModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title" id="editBankModalLabel">Edit Bank</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editBankId" value="${bank.id}">
                        <div class="mb-3">
                            <label for="editBankName" class="form-label">Bank Name</label>
                            <input type="text" class="form-control" id="editBankName" value="${bank.bank_name}">
                        </div>
                        <div class="mb-3">
                            <label for="editShortName" class="form-label">Short Name</label>
                            <input type="text" class="form-control" id="editShortName" value="${bank.short_name}">
                        </div>
                        <div class="mb-3">
                            <label for="editIfscPrefix" class="form-label">IFSC Prefix</label>
                            <input type="text" class="form-control" id="editIfscPrefix" value="${bank.ifsc_prefix}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-info" onclick="updateBank()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('editBankModal'));
    modal.show();
    
    // Focus on the first input field when modal opens
    setTimeout(() => {
        document.getElementById('editBankName')?.focus();
    }, 500);
}
async function updateBankStatusFromModal(status) {
    const modal = document.getElementById('editBankModal');
    if (!modal) {
        showMessage("Edit bank modal not found", "error");
        return;
    }
    
    const bankId = modal.querySelector("#editBankId")?.value || "";
    const action = status === 'active' ? 'activate' : 'deactivate';
    const statusText = status === 'active' ? 'Active' : 'Inactive';
    
    if (!bankId) {
        showMessage("Bank ID not found", "error");
        return;
    }
    
    if (!confirm(`Are you sure you want to ${action} this bank?`)) return;
    
    try {
        const response = await apiFetch(`http://127.0.0.1:8000/banks/${bankId}/status?status=${status}`, {
            method: "PATCH",
            headers: {
                "X-User-Role": "super_admin"
            }
        });
        
        if (response.ok) {
            showMessage(`Bank status updated to ${statusText}`, "success");
            const bsModal = bootstrap.Modal.getInstance(document.getElementById('editBankModal'));
            bsModal.hide();
            loadBanks(currentStatusFilter);
        } else {
            const errorText = await response.text();
            showMessage(errorText || `Failed to ${action} bank`, "error");
        }
    } catch (error) {
        showMessage(`Error ${action} bank`, "error");
    }
}

async function updateBank() {
    const modal = document.getElementById('editBankModal');
    if (!modal) {
        showMessage("Edit bank modal not found", "error");
        return;
    }
    
    const bankId = modal.querySelector("#editBankId")?.value || "";
    const bankName = modal.querySelector("#editBankName")?.value.trim() || "";
    const shortName = modal.querySelector("#editShortName")?.value.trim() || "";
    const ifscPrefix = modal.querySelector("#editIfscPrefix")?.value.trim() || "";
    
    if (!bankId) {
        showMessage("Bank ID not found", "error");
        return;
    }
    
    if (!bankName || !shortName || !ifscPrefix) {
        showMessage("Please fill all required fields", "error");
        return;
    }
    
    try {
        const response = await apiFetch(`http://127.0.0.1:8000/banks/${bankId}`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "X-User-Role": "super_admin"
            },
            body: JSON.stringify({
                bank_name: bankName,
                short_name: shortName,
                ifsc_prefix: ifscPrefix
            })
        });
        
        if (response.ok) {
            showMessage("Bank updated successfully", "success");
            const bsModal = bootstrap.Modal.getInstance(document.getElementById('editBankModal'));
            bsModal.hide();
            loadBanks(currentStatusFilter);
        } else {
            const errorText = await response.text();
            showMessage(errorText || "Failed to update bank", "error");
        }
    } catch (error) {
        showMessage("Error updating bank", "error");
    }
}

async function updateBankStatus(bankId, status) {
    const action = status === 'active' ? 'activate' : 'deactivate';
    const statusText = status === 'active' ? 'Active' : 'Inactive';
    
    if (!confirm(`Are you sure you want to ${action} this bank?`)) return;
    
    try {
        const response = await apiFetch(`http://127.0.0.1:8000/banks/${bankId}/status?status=${status}`, {
            method: "PATCH",
            headers: {
                "X-User-Role": "super_admin"
            }
        });
        
        if (response.ok) {
            showMessage(`Bank status updated to ${statusText}`, "success");
            loadBanks(currentStatusFilter);
        } else {
            const errorText = await response.text();
            showMessage(errorText || `Failed to ${action} bank`, "error");
        }
    } catch (error) {
        showMessage(`Error ${action} bank`, "error");
    }
}

async function confirmDeleteBank(bankId) {
    if (!confirm("Are you sure you want to delete this bank?")) return;
    
    try {
        const response = await apiFetch(`http://127.0.0.1:8000/banks/${bankId}`, {
            method: "DELETE",
            headers: {
                "X-User-Role": "super_admin"
            }
        });
        
        if (response.ok) {
            showMessage("Bank deleted successfully", "success");
            loadBanks(currentStatusFilter);
        } else {
            const errorText = await response.text();
            showMessage(errorText || "Failed to delete bank", "error");
        }
    } catch (error) {
        showMessage("Error deleting bank", "error");
    }
}
        function showMessage(message, type) {
            const alertBox = document.createElement('div');
            alertBox.style.position = 'fixed';
            alertBox.style.top = '20px';
            alertBox.style.right = '20px';
            alertBox.style.padding = '15px';
            alertBox.style.borderRadius = '5px';
            alertBox.style.color = 'white';
            alertBox.style.zIndex = '9999';
            alertBox.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            alertBox.style.animation = 'fadeIn 0.3s ease-out';
            
            if (type === "error") {
                alertBox.style.backgroundColor = '#dc3545';
            } else {
                alertBox.style.backgroundColor = '#28a745';
            }
            
            alertBox.textContent = type === "error" ? `Error: ${message}` : message;
            document.body.appendChild(alertBox);
            
            setTimeout(() => {
                alertBox.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(alertBox);
                }, 300);
            }, 2000);
        }

        function logout() {
            localStorage.clear();
            window.location.href = "index.html";
        }

        function handleLogoPreview(e, imgId, previewId) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 1024 * 1024) {
                    showMessage("File size must be less than 1MB", "error");
                    e.target.value = "";
                    return;
                }
                
                if (!file.type.match("image/jpeg|image/png|image/gif")) {
                    showMessage("Only JPEG, PNG and GIF images are allowed", "error");
                    e.target.value = "";
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(imgId).src = e.target.result;
                    document.getElementById(previewId).style.display = "block";
                }
                reader.readAsDataURL(file);
            }
        }
        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            setActiveNavLink();
            // Logo preview for create form
            document.getElementById("companyLogo")?.addEventListener("change", function(e) {
                handleLogoPreview(e, "logoPreviewImg", "logoPreview");
            });
            
            // Logo preview for edit form
            document.getElementById("editCompanyLogo")?.addEventListener("change", function(e) {
                handleLogoPreview(e, "editLogoPreviewImg", "editLogoPreview");
            });
            document.querySelectorAll('#sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    if (page) {
                        updateActiveNavLink(page);
                    }
                });
            });
        });
    </script>
</body>
</html>